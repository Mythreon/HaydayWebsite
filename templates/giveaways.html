{% extends 'base.html' %}

{% block title %}üéâ Giveaways - HayDay üçÄ{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <script src="{{ url_for('static', filename='js/giveaway_timer.js') }}"></script>
  <style>
    .giveaway-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      padding: 30px;
      box-sizing: border-box;
    }
    .giveaway-card {
      background-color: #fff;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      transition: all 0.3s ease;
    }
    body.dark .giveaway-card {
      background-color: #1e1e1e;
      color: #eee;
    }
    .giveaway-card h3 {
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: #4caf50;
    }
    .giveaway-card p {
      font-size: 15px;
      line-height: 1.4;
      margin: 6px 0;
    }
    .giveaway-card p strong {
      color: #ccc;
      font-weight: 600;
      margin-right: 4px;
    }
    .countdown {
      font-weight: bold;
      color: #ff9800;
    }
    .you-entered {
      opacity: 1;
      transition: opacity 0.3s ease;
      display: inline-block;
      background: #2e7d32;
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-top: 6px;
    }
    .you-entered.show {
      opacity: 1;
    }
    .giveaway-card details {
      margin-top: 10px;
    }
    .giveaway-card details summary {
      cursor: pointer;
      font-weight: bold;
      color: #0077cc;
    }
    .view-participants-btn {
      margin-top: 10px;
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      background-color: #0077cc;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    .participants-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.8);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .participants-modal.show {
      display: flex;
    }
    .modal-content {
      background: #1e1e1e;
      padding: 20px;
      max-height: 85vh;
      overflow-y: auto;
      width: 100%;
      max-width: 500px;
      border-radius: 12px;
      color: #eee;
      box-sizing: border-box;
    }
    .close-button {
      float: right;
      background: none;
      border: none;
      color: #eee;
      font-size: 18px;
      cursor: pointer;
    }
    .participant-list {
      margin-top: 20px;
    }
    .participant-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }
    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
    }
    .name {
      font-weight: bold;
    }
    .entries {
      font-size: 14px;
      font-weight: 500;
      color: #ccc;
    }
    .participant-row.me {
      background: #1e5e2e;
      border-radius: 6px;
    }
    body {
      font-family: 'Segoe UI', 'Inter', 'Roboto', sans-serif;
    }
    .verify-warning {
      background: #a32d2d;
      color: white;
      padding: 10px;
      border-radius: 10px;
      font-size: 0.95rem;
      margin-top: 10px;
      line-height: 1.4;
    }
    .verify-warning a {
      color: #fff;
      text-decoration: underline;
    }
    .refresh-btn {
      background: #d32f2f;
      color: white;
      padding: 6px 14px;
      border-radius: 8px;
      text-decoration: none;
      display: inline-block;
      margin: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background 0.2s ease, transform 0.1s ease;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
    }
    .refresh-btn:hover {
      background: #b72b2b;
      transform: scale(1.03);
    }
    input[type="text"] {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #2c2c2c;
      color: white;
      width: 100%;
      box-sizing: border-box;
    }
    @media (max-width: 600px) {
      .giveaway-card {
        padding: 16px;
      }
      .giveaway-card h3 {
        font-size: 1rem;
      }
      .view-participants-btn {
        width: 100%;
        padding: 10px;
        font-size: 15px;
      }
      .participants-modal {
        padding: 10px;
      }
      .modal-content {
        padding: 15px;
        max-height: 85vh;
        font-size: 0.95rem;
      }
      .participant-row {
        flex-direction: row;
        align-items: center;
        font-size: 14px;
      }
      .countdown {
        font-size: 0.95rem;
      }
      .you-entered {
        font-size: 0.75rem;
        width: 100%;
        text-align: center;
      }
      .verify-warning {
        font-size: 0.85rem;
      }
    }
    .giveaway-card form {
      background: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      margin: 0 !important;
      border: none !important;
      display: block;
    }
    .giveaway-card form label {
      margin-top: 10px;
      display: block;
      font-size: 0.9rem;
      color: inherit;
    }
    .giveaway-card input[type="checkbox"] {
      margin-right: 6px;
      transform: scale(1.1);
      vertical-align: middle;
    }
  </style>
{% endblock %}

{% block content %}

<main style="padding-top: 80px; padding-bottom: 80px;">

  {% if discord_id %}
  <section id="won-section" style="padding: 20px;">
    <h2 style="text-align:center;">üèÜ Recently Won Giveaways</h2>
    <div id="won-giveaway-cards" class="giveaway-grid"></div>
    <div id="won-pagination" style="text-align:center; margin-top: 10px;"></div>
  </section>
  {% endif %}

  <h1 style="text-align:center;">üéâ Ongoing Giveaways</h1>

  <div class="giveaway-grid">
    {% for g in giveaways %}
    <div class="giveaway-card">
      <h3>{{ g.prize }}</h3>
      <p style="display: flex; align-items: center; gap: 10px;">
        {% if g.host_avatar %}
        <img src="{{ g.host_avatar }}" alt="avatar" style="width: 26px; height: 26px; border-radius: 50%;">
        {% endif %}
        <strong>Host:</strong> {{ g.host_display }}
      </p>
      <p><strong>Ends:</strong> <span class="countdown" data-end="{{ g.end_time_ts }}"></span></p>
      <p><strong>Winners:</strong> {{ g.winners }}</p>
      <p><strong>Entries:</strong> <span class="entry-count" data-msgid="{{ g.message_id }}">{{ g.entry_count }}</span></p>
      {% if g.required_role_name %}
      <p><strong>Required Role:</strong> <span style="color: #ff6666;">{{ g.required_role_name }}</span></p>
      {% endif %}
      <p><strong>Link:</strong> <a href="https://discord.com/channels/{{ g.guild_id }}/{{ g.channel_id }}/{{ g.message_id }}" target="_blank">Jump to Giveaway</a></p>

      <div class="giveaway-action-wrapper" data-msgid="{{ g.message_id }}" data-has-bypass="{{ '1' if g.has_bypass else '0' }}">
        {% if discord_id in g.participants %}
          <div class="you-entered">You‚Äôve joined! ({{ g.participants[discord_id] }} entries)</div>
          <form class="leave-form" style="margin-top: 10px;">
            <input type="hidden" name="message_id" value="{{ g.message_id }}">
            <button type="submit" class="view-participants-btn" style="background-color: #d32f2f;">‚ùå Leave Giveaway</button>
          </form>

        {% elif g.not_in_guild %}
          <div class="you-entered" style="background-color: #a32d2d;">
            üîí Please <a href="https://discord.gg/haydayy" target="_blank" style="color: white; text-decoration: underline;">join our Discord server</a> to join giveaways.<br>
            <small>If you just joined, <a href="/logout?next=/login?next=/giveaways" style="color: white; text-decoration: underline;">‚Üª refresh login</a>.</small>
          </div>

        {% elif not g.can_join %}
          <div class="you-entered" style="background-color: #a32d2d;">‚ùå Not eligible to join this giveaway</div>

        {% else %}
          <form class="join-form" data-msgid="{{ g.message_id }}" data-has-bypass="{{ '1' if g.has_bypass else '0' }}" style="margin-top: 10px;">
            <input type="hidden" name="message_id" value="{{ g.message_id }}">

            {% if g.has_bypass %}
            <label style="display:block; margin-top: 8px;">
              <input type="checkbox" required id="confirm-{{ g.message_id }}">
              I confirm I‚Äôve read the giveaway title and understand all additional requirements.
            </label>
            {% endif %}

            <button type="submit"
                    class="view-participants-btn"
                    style="background-color: #4caf50;">
              üéâ Join Giveaway
            </button>
          </form>
        {% endif %}
      </div>

      <button onclick="openParticipantsModal({{ loop.index0 }})" class="view-participants-btn">üîç View Entry Stats & Participants</button>

      <div class="participants-modal" id="modal-{{ loop.index0 }}">
        <div class="modal-content">
          <button class="close-button" onclick="closeParticipantsModal({{ loop.index0 }})">‚úñ</button>
          <h3>üéâ Participants</h3>

          <input type="text" placeholder="Search participants" oninput="filterParticipants({{ loop.index0 }}, this.value)">

          <div class="participant-list" id="participant-list-{{ loop.index0 }}">
          </div>
        </div>
      </div>

    </div>
    {% endfor %}
  </div>

</main>

<script>
  function updateCountdowns() {
    const countdownElems = document.querySelectorAll('.countdown');
    const now = Date.now();
    countdownElems.forEach(el => {
      const endTs = parseInt(el.dataset.end, 10) * 1000;
      let diff = endTs - now;
      if (diff < 0) {
        el.textContent = 'Ended';
        return;
      }
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      diff -= days * (1000 * 60 * 60 * 24);
      const hours = Math.floor(diff / (1000 * 60 * 60));
      diff -= hours * (1000 * 60 * 60);
      const minutes = Math.floor(diff / (1000 * 60));
      diff -= minutes * (1000 * 60);
      const seconds = Math.floor(diff / 1000);
      let text = '';
      if (days > 0) text += days + 'd ';
      text += String(hours).padStart(2, '0') + 'h ';
      text += String(minutes).padStart(2, '0') + 'm ';
      text += String(seconds).padStart(2, '0') + 's';
      el.textContent = text;
    });
  }
  setInterval(updateCountdowns, 1000);
  updateCountdowns();

  const giveawaysData = {{ giveaways | tojson }};

  function openParticipantsModal(idx) {
    const modal = document.getElementById('modal-' + idx);
    modal.classList.add('show');
    populateParticipantsList(idx);
  }
  function closeParticipantsModal(idx) {
    const modal = document.getElementById('modal-' + idx);
    modal.classList.remove('show');
  }

  function populateParticipantsList(idx) {
    const participantList = document.getElementById('participant-list-' + idx);
    participantList.innerHTML = '';

    const giveaway = giveawaysData[idx];
    const discordId = "{{ discord_id if discord_id else '' }}";

    let participantsArray = Object.entries(giveaway.participants).map(([id, entries]) => ({
      id,
      entries
    }));
    participantsArray.sort((a, b) => b.entries - a.entries);

    participantsArray.forEach(p => {
      const row = document.createElement('div');
      row.className = 'participant-row';
      if (p.id === discordId) row.classList.add('me');

      const avatarUrl = giveaway.participant_avatars && giveaway.participant_avatars[p.id] 
                        ? giveaway.participant_avatars[p.id]
                        : 'https://cdn.discordapp.com/embed/avatars/0.png';

      row.innerHTML = `
        <img src="${avatarUrl}" alt="avatar" class="avatar">
        <div class="name">${p.id === discordId ? 'You' : p.id}</div>
        <div class="entries">${p.entries} entries</div>
      `;
      participantList.appendChild(row);
    });
  }

  function filterParticipants(idx, searchTerm) {
    const participantList = document.getElementById('participant-list-' + idx);
    const rows = participantList.querySelectorAll('.participant-row');
    const term = searchTerm.toLowerCase();

    rows.forEach(row => {
      const nameDiv = row.querySelector('.name');
      if (nameDiv.textContent.toLowerCase().includes(term)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  document.querySelectorAll('.join-form').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const msgid = form.dataset.msgid;
      const hasBypass = form.dataset.has-bypass === '1';

      if (hasBypass) {
        const checkbox = form.querySelector('input[type="checkbox"]');
        if (!checkbox.checked) {
          alert('Please confirm you have read the giveaway requirements.');
          return;
        }
      }

      const res = await fetch('/join_giveaway', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message_id: msgid})
      });
      const data = await res.json();
      if (data.success) {
        location.reload();
      } else {
        alert(data.message || 'Failed to join giveaway');
      }
    });
  });

  document.querySelectorAll('.leave-form').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const msgid = form.querySelector('input[name="message_id"]').value;
      const res = await fetch('/leave_giveaway', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message_id: msgid})
      });
      const data = await res.json();
      if (data.success) {
        location.reload();
      } else {
        alert(data.message || 'Failed to leave giveaway');
      }
    });
  });

  // I think I hugely messed up...
  
</script>

{% endblock %}
